/* notebook - v0.0.1
 * https://github.com/wolongxzg/nodejs
 * Copyright (c) 2012 wolongxzg; */
KISSY.add("brix/brick",function(a,b){function c(b,c){return a.isString(c)?b[c]:c}function d(){var b=this;b.pagelet=arguments[0].pagelet;var c=b.pagelet?b.pagelet:b;c.on("rendered",function(){b.initialize(),b._bindEvent()}),d.superclass.constructor.apply(this,arguments),c.get("rendered")&&(b.initialize(),b._bindEvent());var e=b.get("tmpler"),f;e?(a.each(e.bricks,function(a,b){return f=b,!1}),e.bricks[f].brick=this):f=arguments[0].el.split("#")[1];var g=b.constructor.RENDERER;g&&c.get("dataset").setRenderer(g,b,f)}return d.ATTACH={},d.ATTRS={events:{}},a.extend(d,b,{initialize:function(){},_detachEvent:function(){var b=this,c=b.constructor.ATTACH;c&&b._removeEvents(c);var d=b.constructor.DOCATTACH;d&&b._removeEvents(d,a.one(document)),b._undelegateEvents();var e=b.get("events");e&&this._removeEvents(e)},_bindEvent:function(){var b=this,c=b.constructor.ATTACH;c&&this._addEvents(c);var d=b.constructor.DOCATTACH;d&&this._addEvents(d,a.one(document)),b._delegateEvents();var e=b.get("events");e&&this._addEvents(e)},events:{},_removeEvents:function(a,b){b=b||this.get("el");for(var d in a){var e=a[d];for(var f in e){var g=c(this,e[f]);b.undelegate(f,d,g,this)}}},_addEvents:function(a,b){b=b||this.get("el");for(var d in a){var e=a[d];for(var f in e){var g=c(this,e[f]);b.delegate(f,d,g,this)}}},_delegateEvents:function(){var a=this.events,b=this.get("el")[0],c=this;for(var d in a)(function(){var a=d;b["on"+a]=function(){var b=arguments[0]||window.event,d=b.target||b.srcElement;d.nodeType!=1&&(d=d.parentNode);var e=d.getAttribute("bx"+a);if(e){var f=e.split("|"),g,h;for(var i=0;i<f.length;i++){g=f[i].split(":"),h=g.shift();var j=g[g.length-1],k=!1;if(j=="_halt_"||j=="_preventDefault_")b.preventDefault?b.preventDefault():b.returnValue=!1,k=!0;if(j=="_halt_"||j=="_stop_")b.stopPropagation?b.stopPropagation():b.cancelBubble=!0,k=!0;k&&g.pop(),c.events&&c.events[a]&&c.events[a][h]&&c.events[a][h].call(c,d,g)}}d=null}})()},_undelegateEvents:function(){var a=this.events,b=this.get("el")[0],c=this;for(var d in a)(function(){var a=d;b["on"+a]=null})()}}),d},{requires:["brix/chunk"]}),KISSY.add("brix/chunk",function(a,b,c,d,e){function g(){g.superclass.constructor.apply(this,arguments);var a=this;a._buildTmpler();var b=a.get("tmpler");b&&(b.inDom?(a.__set("el",a.get("tmpl")),a.__set("rendered",!0),a.fire("rendered")):a.get("autoRender")&&a.render())}var f=b.all;return g.ATTRS={el:{getter:function(b){return a.isString(b)&&(b=f(b)),b}},container:{value:"body",getter:function(b){return a.isString(b)&&(b=f(b)),b}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!1},data:{value:!1},dataset:{value:!1}},a.extend(g,c,{_buildTmpler:function(){var a=this,b=a.get("tmpler");if(!b&&!a.pagelet){var c=a.get("tmpl");c&&(b=new e(c),a.set("tmpler",b),a._buildDataset())}},_buildDataset:function(){var b=this,c=b.get("dataset");if(!c&&!b.pagelet){var e=b.get("data")||{};e=a.clone(e),c=new d({data:e}),b.set("dataset",c)}c&&c.on("afterDataChange",function(a){b._render(a.subAttrName,a.newVal)})},addTmpl:function(a,b){var c=this.pagelet?this.pagelet:this;return c.get("tmpler").addTmpl(a,b)},setChunkData:function(b,c){var d=this.pagelet?this.pagelet:this,e=d.get("dataset");c=a.clone(c),e.set("data."+b,c)},render:function(){var a=this;a.get("rendered")||(a._render("data",a.get("dataset").get("data")),a.__set("rendered",!0),a.fire("rendered"))},_render:function(c,d){var e=this.pagelet?this.pagelet:this,f=e.get("tmpler");if(c.split(".").length>1)c=c.replace(/^data\./,""),e._renderTmpl(f.bricks,c,d);else{var g=new b(f.to_html(d)),h=e.get("container"),i;g.length>1?(i=new b('<div id="'+a.guid("brick_container")+'"></div>'),i.append(g)):(g.attr("id")||g.attr("id",a.guid("brick_container")),i=g),h.append(i),e.__set("el","#"+i.attr("id")),g=null,i=null}},_renderTmpl:function(b,c,d){a.each(b,function(b){a.each(b.tmpls,function(b,e){if(a.inArray(c,b.datakey)){var f={};a.each(b.datakey,function(a){var b=d,c=a.split("."),e=c.length,g=0;while(g!=e)b=b[c[g]],g++;f[c[e-1]]=b,b=null}),a.one("#"+b.id).html(b.tmpler.to_html(f)),f=null}}),this._renderTmpl(b.bricks,c,d)},this)},destroy:function(){var a=this,b=a.get("el"),c=null;a.pagelet&&(c=b.attr("id"));var d=a.get("tmpler");d&&d.bricks&&a._destroyBricks(d.bricks,c),b.remove()},_destroyBricks:function(b,c){var d=this;a.each(b,function(a,e){if(c){if(c==e)return d._destroyBrick(a),delete b[e],!1;d._destroyBricks(a.bricks)}else d._destroyBrick(a),delete b[e]})},_destroyBrick:function(a){var b=this;a.brick&&(a.brick._detachEvent(),b._destroyBricks(a.bricks),a.brick.pagelet=null,a.brick=null,delete a)}}),g},{requires:["node","base","brix/dataset","brix/tmpler"]});