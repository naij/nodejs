KISSY.add("app/views/manage/item/item_set",function(a,e,t,i,l,s,n){var d=l.all;return function(a){return a.prototype.template='<div class=steps> <ol class=clearfix> <li class=ks-active>1 \u5185\u5bb9\u8bbe\u7f6e</li> <li class=unfinished>2 \u6dfb\u52a0\u5b9d\u8d1d</li> <li class=unfinished>3 \u5b8c\u6210</li> </ol> </div> <div class="item-cnt form-auth"> <form action="" id=validatForm bx-name="validation" bx-path="components/validation/index" bx-tmpl="detail" bx-datakey="detail,typeList,channelList"> {{#detail}} <ul> <li class=field> <label class=field-label>\u5185\u5bb9ID\uff1a</label> <input type=text class=input name=id id=J_contentId value="{{id}}" {{#id}}disabled{{/id}}> </li> <li class=field> <label class=field-label>\u5185\u5bb9\u6807\u9898\uff1a</label> <input type=text class="input input-title" name=title id=J_input_title placeholder="\u8bf7\u8f93\u5165\u5185\u5bb9\u7684\u6807\u9898\uff0c20\u5b57\u4ee5\u5185" data-valid="{length:[1,20]}" value="{{title}}"> <span class=field-count bx-name="textcount" bx-path="components/textcount/" bx-config="{input: \'#J_input_title\', count: 20}">0/20</span> </li> <li class=field> <label class=field-label>\u5185\u5bb9\u5730\u5740\uff1a</label> <input type=text class="input input-url" name=link data-valid="{trim:true,regex: [/^http:\\/\\/({{reg}})[a-zA-Z0-9\\.\\,\\?\\\'\\\\/\\+&amp;%\\$#\\=~_\\-@]*$/,\'\u8bf7\u8f93\u5165\u4ee5&nbsp;http://{{domain}}&nbsp;\u5f00\u5934\u7684\u94fe\u63a5\']}" placeholder="\u8bf7\u8f93\u5165\u4ee5&nbsp;http://{{domain}}&nbsp;\u5f00\u5934\u7684\u94fe\u63a5" value="{{link}}"> </li> <li class=field> <label class=field-label>\u5185\u5bb9\u7c7b\u578b\uff1a</label> <div bx-name="dropdown" class=dropdown id=J_dropdown_type> {{#typeList}} {{#selected}} <span class=dropdown-hd> <span class=dropdown-text value="{{id}}">{{name}}</span> <i class="iconfont icon-arrow-down">&#459</i> </span> <input type=hidden name=typeId id=J_typeId value="{{id}}"> {{/selected}} {{/typeList}} <ul class=dropdown-list> {{#typeList}} <li class=dropdown-item><span value="{{id}}">{{name}}</span></li> {{/typeList}} </ul> </div> </li> <li class=field> <label class=field-label>\u6240\u5c5e\u9891\u9053\uff1a</label> <div bx-name="dropdown" class=dropdown id=J_dropdown_channel> {{#channelList}} {{#selected}} <span class=dropdown-hd> <span class=dropdown-text value="{{id}}">{{name}}</span> <i class="iconfont icon-arrow-down">&#459</i> </span> <input type=hidden name=channelId id=J_channelId value="{{id}}"> {{/selected}} {{/channelList}} <ul class=dropdown-list> {{#channelList}} <li class=dropdown-item><span value="{{id}}">{{name}}</span></li> {{/channelList}} </ul> </div> </li> <li class=field> <label class=field-label>\u5185\u5bb9\u6807\u7b7e\uff1a</label> <div class=field-set> <div bx-tmpl="tagList" bx-datakey="tagList"> <ul class="tag-cnt clearfix"> {{#tagList}} <li class="tag-item {{#isActive}}active{{/isActive}}" mx-click="tagSelect{tagId:{{id}}}">{{name}}</li> {{/tagList}} </ul> <input type=hidden name=tagIds id=J_tagId value="{{tagIds}}"> <div class=ux-valid id=J_tagMsg><p class=estate><span class=label></span></p></div> </div> <div class=custom-tags> <p class=tips>\u81ea\u5b9a\u4e49\u6807\u7b7e(\u7528\u7a7a\u683c\u9694\u5f00\uff0c2-5\u4e2a\u6807\u7b7e\uff0c\u6bcf\u4e2a\u6807\u7b7e\u5c11\u4e8e2-5\u4e2a\u6c49\u5b57)</p> <input name=customTags type=text class=input id=J_input_custags data-valid="{minLength:[2,false]}" placeholder="\u4f8b:\u886c\u886b \u5e3d\u5b50" data-messagebox="#J_custagMsg" value="{{customTags}}"> <div class=ux-valid id=J_custagMsg><p class=estate><span class=label></span></p></div> </div> </div> </li> <li class=field> <label class=field-label>\u5185\u5bb9\u63cf\u8ff0\uff1a</label> <div class=field-set> <textarea class="textarea item-desc" name=desc id=J_input_desc data-valid="{}" placeholder="\u8f93\u5165\u8be5\u5185\u5bb9\u7684\u63cf\u8ff0\uff0c200\u5b57\u4ee5\u5185">{{desc}}</textarea> <div class="textarea-count field-count" bx-name="textcount" bx-path="components/textcount/" bx-config="{input: \'#J_input_desc\', count: 200}">0/200</div> </div> </li> <li class=field> <label class=field-label>\u5c55\u793a\u56fe\u7247\uff1a</label> <div class=field-set bx-tmpl="cover" bx-datakey="hasUpload,cover,images"> {{^hasUpload}} <span class="btn btn-size25 btn-disabled">\u6d4f\u89c8\u6587\u4ef6</span> {{/hasUpload}} {{#hasUpload}} <a href="javascript:;" class="btn btn-size25" id=J_iframe_upload>\u6d4f\u89c8\u6587\u4ef6</a> {{/hasUpload}} <p class=color-grey style="margin-top:5px;">\u6700\u5c0f\u4e0d\u4f4e\u4e8e 500*500\u50cf\u7d20\uff0c\u5efa\u8bae\u4f7f\u7528\uff1a500*800\u50cf\u7d20\uff1b\u6bd4\u4f8b\u4e3a1:1.6\uff0c \u56fe\u7247\u5927\u5c0f\u9650\u5236\u57281M\u4ee5\u5185</p> <ul class="preview-list clearfix"> <li class=preview> {{^cover}}<em>\u4e3b\u56fe</em>{{/cover}} {{#cover}} <img src="{{url}}_80x80.jpg"> <span class="del-btn iconfont" mx-click="del{index:4}">&#223</span> <input type=hidden name=cover id=J_mainImg value="{{filename}}"> {{/cover}} </li> {{#images}} <li class=preview> {{^filename}}<em>\u9644\u56fe</em>{{/filename}} {{#filename}} <img src="{{url}}_80x80.jpg"> <span class="del-btn iconfont" mx-click="del{index:{{__index__}}}">&#223</span> {{/filename}} </li> {{/images}} </ul> <div class=ux-valid id=J_mainImgMsg><p class="estate error"><span class=label></span></p></div> </div> </li> {{/detail}} </ul> <p> <a href="#" mx-click=submit class="btn btn-blue btn-size40">\u4e0b\u4e00\u6b65</a> </p> </form> </div>',a}(e.extend({init:function(a){this.manage("data",a)},render:function(){var a=this,e=this.location.params,i=e.id;a.manage(i?t.fetchAll([{name:"item_edit",urlParams:{id:i,bizType:bizType}}],function(e,t){var i=t.get("data").result,l=i.domain[0],s=i.detail,n=s.typeId,d=s.channelId,c=a.wrapTypeList(i.typeList,n),o=a.wrapTypeList(i.channelList,d),p=s.tagIds,r=i.tagList;s.customTags=s.customTags.join(" "),s.hasUpload=!0;for(var m=0;m<p.length;m++)for(var g=0;g<r.length;g++){var u=r[g];p[m]==u.id&&(u.isActive=!0)}s.tagIds=s.tagIds.join(","),a.manage("detail",s),a.operateUpload(),a.setViewPagelet({detail:s,domain:l,typeList:c,channelList:o,tagList:r,cover:s.cover,images:s.images,hasUpload:a.getManaged("hasUpload")},function(){a.components()})}):t.fetchAll([{name:"item_create",urlParams:{bizType:bizType,id:""}}],function(e,t){var i=t.get("data").result,l=i.domain[0],s=i.domain.join("|"),n=i.detail,d=a.wrapTypeList(i.typeList),c=a.wrapTypeList(i.channelList),o=i.tagList;n.id=0==n.id?"":n.id,n.hasUpload=!0,a.manage("detail",n),a.operateUpload(),a.setViewPagelet({detail:n,domain:l,reg:s,typeList:d,channelList:c,tagList:o,cover:n.cover,images:n.images,hasUpload:a.getManaged("hasUpload")},function(){a.components()})}))},wrapTypeList:function(e,t){return t?a.each(e,function(a){a.id==t&&(a.selected=!0)}):e[0].selected=!0,e},components:function(){var e=this,i=e.getManaged("pagelet"),l=i.getBrick("validatForm").valid;l.add("#J_contentId",{trim:"\u5185\u5bb9ID\u4e24\u7aef\u4e0d\u80fd\u542b\u6709\u7a7a\u683c",regex:[/^[0-9]+$/,"\u5185\u5bb9ID\u53ea\u80fd\u662f\u6570\u5b57"],func:function(e){var t="";return a.IO({type:"get",url:"/sitemanager/content/checkContentId.htm",data:{id:e},dataType:"json",async:!1,success:function(a){a.data.status||(t="\u8be5\u5185\u5bb9ID\u5df2\u7ecf\u5b58\u5728\uff0c\u8bf7\u66f4\u6362\u5185\u5bb9ID")}}),t}}),e.manage("valid",l);var s=i.getBrick("J_dropdown_channel"),c=d("#J_typeId").val();s.on("selected",function(a){e.manage(t.fetchAll([{name:"get_tagList",urlParams:{channelId:a.value,typeId:c,bizType:bizType}}],function(a,e){var t=e.get("data").result;i.setChunkData("tagList",t.tagList)}))});var o=new n({el:"#J_iframe_upload",name:"contentImage",zIndex:1e4,action:"/sitemanager/content/uploadImage.htm",accept:"image/jpeg,image/jpg,image/gif,image/png"});e.manage("upload",o);var p,r=e.getManaged("detail");o.on("uploadComplete",function(t){var l=t.data,s=d("#J_mainImg").val();p=[],a.one("#J_mainImgMsg").one("span").html(""),a.each(r.images,function(a){a.filename&&p.push(a)}),l&&l.status&&(s?p.push({filename:l.result.filename,url:l.result.url}):r.cover={filename:l.result.filename,url:l.result.url},r.images=p,e.operateUpload(),i.setChunkData("hasUpload",r.hasUpload),i.setChunkData("cover",r.cover),i.setChunkData("images",r.images)),o.reset()}),o.on("uploadError",function(e){o.reset(),a.one("#J_mainImgMsg").show(),a.one("#J_mainImgMsg").one("span").html(e.msg)})},operateUpload:function(){for(var a=this,e=(a.getManaged("pagelet"),a.getManaged("detail")),t=[],i=e.images,l=0,s=0;4>s;s++)i&&i[s]?(t.push(i[s]),l++):t.push({});e.images=t,e.hasUpload=l>=4&&e.cover?!1:!0},"tagSelect<click>":function(a){var e=this,t=(e.getManaged("pagelet"),d("#"+a.currentId)),i=a.params.tagId;return t.hasClass("active")?!1:(t.addClass("active").siblings("li").removeClass("active"),void d("#J_tagId").val(i))},"del<click>":function(e){var t=this,i=t.getManaged("pagelet"),l=(d("#"+e.currentId),t.getManaged("detail")),s=t.getManaged("upload"),n=e.params.index;4==n&&(l.cover="");var c=a.clone(l.images);a.each(c,function(a,e){e==n&&l.images.splice(e,1)}),t.operateUpload(),i.setChunkData("hasUpload",l.hasUpload),i.setChunkData("cover",l.cover),i.setChunkData("images",l.images),s.reset()},"submit<click>":function(e){e.halt();var i=this,l={},n=(i.getManaged("pagelet"),i.getManaged("detail")),c=i.getManaged("valid"),o=d("#J_contentId").val(),p=d("#J_input_title").val();if(c.isValid()){var r=d("#validatForm").all(":input:disabled").removeAttr("disabled");l=a.mix(l,a.unparam(a.IO.serialize("#validatForm"))),r.attr("disabled","disabled");var m=d("#J_tagId").val();if(!m){var g=d("#J_tagMsg");return g.one(".estate").addClass("error"),g.one(".label").text("\u8bf7\u81f3\u5c11\u9009\u62e9\u4e00\u4e2a\u5185\u5bb9\u6807\u7b7e\u3002"),void g.slideDown(.1,function(){a.later(function(){g&&g.slideUp()},3e3)})}var u=d("#J_input_custags").val(),v=!1;u=u.replace(/\s+/g,",").split(",");for(var f=0;f<u.length;f++){var h=u[f];if(h.length<2||h.length>5){v=!0;break}}if(v){var g=d("#J_custagMsg");return g.one(".estate").addClass("error"),g.one(".label").text("\u81ea\u5b9a\u4e49\u6807\u7b7e\u957f\u5ea62-5\u4e2a\u6c49\u5b57\u3002"),void g.slideDown(.1)}if(u.length<2||u.length>=6){var g=d("#J_custagMsg");return g.one(".estate").addClass("error"),g.one(".label").text("\u81ea\u5b9a\u4e49\u6807\u7b7e\u4e2a\u6570\u57282-5\u4e2a\u4e4b\u95f4\u3002"),void g.slideDown(.1)}l=a.mix(l,{customTags:u,bizType:bizType}),l.desc=l.desc.replace(/\n/g," ");var b=n.cover&&n.cover.filename;if(!b){var g=d("#J_mainImgMsg");return g.one(".estate").addClass("error"),g.one(".label").text("\u8bf7\u4e0a\u4f20\u4e3b\u56fe\u3002"),void g.slideDown(.1,function(){a.later(function(){g&&g.slideUp()},3e3)})}a.mix(l,{cover:n.cover.filename});var x=[],_=n.images;_.length>0&&a.each(_,function(a){a.filename&&x.push(a.filename)}),a.mix(l,{images:x}),i.manage(t.fetchAll([{name:"submit_item",type:"post",postParams:l}],function(a,e){var t=e.get("data"),l=i.getManaged("data");t.status?l.callback(o,p):s.showGlobalTip(t.message)}))}}}))},{requires:["mxext/view","app/models/modelmanager","magix/vom","node","app/util/util","components/iframeupload/index"]});